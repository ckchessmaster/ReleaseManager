trigger:
  batch: true
  branches:
    include:
    - master
  paths:
    include:
    - web-src/*

variables:
  vmImageName: 'ubuntu-latest'
  workingDirectory: '$(System.DefaultWorkingDirectory)/web-src'
  azureSubscription: 'azure-default'
  appName: uan-app-release-manager
  nodeVersion: '12.13'

pool:
  vmImage: $(vmImageName)

stages:
- stage: Test
  displayName: Test
  jobs:
  # - job: Lint
  #   displayName: Lint
  #   steps:
  #   - task: NodeTool@0
  #     displayName: Set Node Version
  #     inputs:
  #       versionSpec: $(nodeVersion)

  #   - script: npm run lint
  #     displayName: Lint code
  #     workingDirectory: $(workingDirectory)

  - job: UnitTest
    displayName: UnitTest
    steps:
    - task: NodeTool@0
      displayName: Set Node Version
      inputs:
        versionSpec: $(nodeVersion)

    - script: npm install
      displayName: Install Dependencies
      workingDirectory: $(workingDirectory)

    - script: npm run test:unit
      displayName: Run Unit Tests
      workingDirectory: $(workingDirectory)

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testRunner: JUnit
        testResultsFiles: '$(workingDirectory)/**/TEST-RESULTS.xml'

    - task: PublishCodeCoverageResults@1
      inputs: 
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(workingDirectory)/**/*coverage.xml'
        reportDirectory: '$(workingDirectory)/**/coverage'

- stage: Build
  displayName: Build
  dependsOn: Test
  condition: succeeded('Test')

  jobs:
  - job: Build
    displayName: Build
    steps:
    - task: NodeTool@0
      displayName: Set Node Version
      inputs:
        versionSpec: $(nodeVersion)

    - script: npm install
      displayName: Install Dependencies
      workingDirectory: $(workingDirectory)

    - script: npm run build
      displayName: Build Vue App
      workingDirectory: $(workingDirectory)

    # - task: ArchiveFiles@2
    #   displayName: Archive files
    #   inputs:
    #     rootFolderOrFile: '$(workingDirectory)/dist'
    #     includeRootFolder: false
    #     archiveType: zip
    #     replaceExistingArchive: true
    #     archiveFile: '$(Build.ArtifactStagingDirectory)/ReleaseManagerWebApp$(Build.BuildId).zip'

    - publish: '$(workingDirectory)/dist'
      displayName: 'Upload Package'
      artifact: site

- stage: Deploy
  displayName: Deploy
  dependsOn: Build
  condition: succeeded('Build')
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - script: azcopy login --service-principal --application-id $(applicationId) --tenant-id=$(tenantId)
            displayName: Login Service Principal
            env:
              AZCOPY_SPA_CLIENT_SECRET: $(AZCOPY_SPA_CLIENT_SECRET)
          - script: 'azcopy cp "$(Pipeline.Workspace)/site" "https://uansagamerelease.blob.core.windows.net/$web" --put-md5'
            displayName: Publish to Azure Blob Storage